<!DOCTYPE html>
<html lang="ru">
<head>
    <title>TVGO</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <div class="main" id="app">
        <!-- Profile Block -->
        <div v-if="showProfileBlock" class="profile-container">
            <div class="profile-header">
                <h1>Профиль пользователя</h1>
            </div>

            <!-- Loading indicator -->
            <div v-if="!user.id || user.id === 'demo123'" class="loading-message">
                <div class="loader"></div>
                <p>Загрузка данных профиля...</p>
            </div>

            <div class="profile-card">
                <div v-if="userPhoto" class="profile-photo">
                    <img :src="userPhoto" alt="User Photo">
                </div>
                <div v-else class="profile-photo-placeholder">
                    <div class="avatar-placeholder">{{ userInitials }}</div>
                </div>

                <div class="profile-info">
                    <div class="info-item">
                        <span class="info-label">Имя:</span>
                        <span class="info-value">{{ user.first_name || 'Не указано' }}</span>
                    </div>
                    <div class="info-item" v-if="user.last_name">
                        <span class="info-label">Фамилия:</span>
                        <span class="info-value">{{ user.last_name }}</span>
                    </div>
                    <div class="info-item" v-if="user.username">
                        <span class="info-label">Username:</span>
                        <span class="info-value">@{{ user.username }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ID:</span>
                        <span class="info-value">{{ user.id }}</span>
                    </div>
                    <div class="info-item" v-if="user.language_code">
                        <span class="info-label">Язык:</span>
                        <span class="info-value">{{ user.language_code.toUpperCase() }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Premium:</span>
                        <span class="info-value">{{ user.is_premium ? '⭐ Да' : 'Нет' }}</span>
                    </div>
                    <div class="info-item" v-if="tg && tg.platform">
                        <span class="info-label">Платформа:</span>
                        <span class="info-value">{{ tg.platform }}</span>
                    </div>
                    <div class="info-item" v-if="tg && tg.version">
                        <span class="info-label">Версия:</span>
                        <span class="info-value">{{ tg.version }}</span>
                    </div>
                </div>
            </div>
            <button @click="goToChannels" class="profile-button">Перейти к каналам</button>
        </div>

        <div v-if="showChannelsBlock" class="channels-container">
            <div class="channels">
                <div v-for="channel in channels"
                     :key="channel.id"
                     class="channel"
                     @click="onImageClick(channel)">
                    <img :src="channel.logoLink" alt="channel-img" class="channel-img">
                    <div class="channel-name">{{ channel.name }}</div>
                </div>
            </div>
            <div class="button-group">
                <button @click="backToProfile" class="btn-secondary">Назад к профилю</button>
                <button @click="close_webapp" class="btn-primary">Закрыть</button>
            </div>
        </div>
        <br>
        
        <div v-if="showPlayerBlock" class="player">
            <h1>{{channel.name}}</h1>
            <video id="my-video" class="video-js" controls preload="auto" width="640" height="264" data-setup='{}' ref="video"></video>
            <button @click="back">Назад</button>
            <br><br><br><br><br>
        </div>
    </div>

    <script>
        // Ждем полной загрузки Telegram WebApp перед инициализацией Vue
        console.log('=== Скрипт загружен ===');
        console.log('window.Telegram:', window.Telegram);
        console.log('window.Telegram.WebApp:', window.Telegram?.WebApp);

        // Функция для ожидания готовности Telegram WebApp
        function waitForTelegramWebApp() {
            return new Promise((resolve) => {
                if (window.Telegram && window.Telegram.WebApp) {
                    console.log('Telegram WebApp уже доступен');
                    resolve(window.Telegram.WebApp);
                } else {
                    console.log('Ожидание загрузки Telegram WebApp...');
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (window.Telegram && window.Telegram.WebApp) {
                            console.log('Telegram WebApp загружен после', attempts, 'попыток');
                            clearInterval(checkInterval);
                            resolve(window.Telegram.WebApp);
                        } else if (attempts > 50) { // Максимум 5 секунд ожидания
                            console.warn('Timeout ожидания Telegram WebApp');
                            clearInterval(checkInterval);
                            resolve(null);
                        }
                    }, 100);
                }
            });
        }

        var app = new Vue({
            el: '#app',
            data: {
                showProfileBlock: true,
                showChannelsBlock: false,
                showPlayerBlock: false,
                tg: null,
                user: {
                    id: '',
                    first_name: '',
                    last_name: '',
                    username: '',
                    language_code: '',
                    is_premium: false
                },
                userPhoto: null,
                channels: [],
                channel: null,
                lock_img_src: 'lock-icon.png',
                hls: null
            },
            computed: {
                userInitials() {
                    const firstName = this.user.first_name || '';
                    const lastName = this.user.last_name || '';
                    const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                    return initials || '?';
                }
            },
            async created() {
                // Ждем полной загрузки Telegram WebApp
                console.log('=== Vue created ===');
                this.tg = await waitForTelegramWebApp();

                if (this.tg) {
                    console.log('✅ Telegram WebApp инициализирован:', this.tg);
                    console.log('Способ открытия (viewportStableHeight):', this.tg.viewportStableHeight);

                    // Вызываем ready() сразу после инициализации
                    this.tg.ready();
                    console.log('✅ Telegram WebApp ready() вызван');
                } else {
                    console.error('❌ Не удалось инициализировать Telegram WebApp');
                }
            },
            async mounted() {
                console.log('=== Vue mounted ===');

                // Даем дополнительное время для инициализации
                await new Promise(resolve => setTimeout(resolve, 200));

                // Разворачиваем приложение на весь экран
                if (this.tg && !this.tg.isExpanded) {
                    this.tg.expand();
                    console.log('✅ Приложение развернуто');
                }

                // Загружаем данные пользователя
                this.loadUserData();

                // Загружаем каналы
                this.fetchChannels();

                // Добавляем повторную попытку загрузки данных через некоторое время
                // Это помогает при открытии через inline кнопки
                setTimeout(() => {
                    console.log('=== Повторная проверка данных пользователя ===');
                    if (!this.user.id || this.user.id === 'demo123') {
                        console.log('Данные пользователя не загружены, пробуем еще раз...');
                        this.loadUserData();
                    } else {
                        console.log('Данные пользователя уже загружены:', this.user.id);
                    }
                }, 1000);

                // И еще одна попытка через 2 секунды
                setTimeout(() => {
                    console.log('=== Финальная проверка данных пользователя ===');
                    if (!this.user.id || this.user.id === 'demo123') {
                        console.log('Финальная попытка загрузки данных...');
                        this.loadUserData();
                    }
                }, 2000);
            },
            methods: {
                // Новый метод для парсинга URL параметров
                loadUserDataFromURL() {
                    console.log('=== Попытка загрузки данных из URL параметров ===');

                    try {
                        const urlParams = new URLSearchParams(window.location.search);

                        // Проверяем наличие параметра user_id
                        const userId = urlParams.get('user_id');

                        if (userId) {
                            console.log('✅ Найдены данные пользователя в URL');

                            this.user = {
                                id: userId,
                                first_name: urlParams.get('first_name') || '',
                                last_name: urlParams.get('last_name') || '',
                                username: urlParams.get('username') || '',
                                language_code: urlParams.get('language_code') || 'ru',
                                is_premium: urlParams.get('is_premium') === 'true' || false
                            };

                            // Проверяем фото профиля
                            const photoUrl = urlParams.get('photo_url');
                            if (photoUrl && photoUrl !== 'null' && photoUrl !== 'undefined') {
                                this.userPhoto = decodeURIComponent(photoUrl);
                            }

                            console.log('✅ Данные пользователя загружены из URL:', this.user);
                            return true;
                        } else {
                            console.log('⚠️ Параметры пользователя не найдены в URL');
                            return false;
                        }
                    } catch (error) {
                        console.error('❌ Ошибка при парсинге URL параметров:', error);
                        return false;
                    }
                },

                loadUserData() {
                    console.log('=== Начало загрузки данных пользователя ===');
                    console.log('Время:', new Date().toISOString());

                    // ПРИОРИТЕТ 1: Попытка загрузки из URL параметров
                    if (this.loadUserDataFromURL()) {
                        console.log('✅ Данные успешно загружены из URL параметров');

                        // Показываем приветствие
                        if (this.tg && this.tg.showAlert && this.user.first_name && this.user.first_name !== 'Демо') {
                            const userName = this.user.first_name + (this.user.last_name ? ' ' + this.user.last_name : '');
                            this.tg.showAlert('Добро пожаловать, ' + userName + '!');
                        }
                        return;
                    }

                    if (!this.tg) {
                        console.error('Telegram WebApp не инициализирован');
                        this.setDemoUser();
                        return;
                    }

                    // Выводим всю информацию о Telegram WebApp для отладки
                    console.log('Telegram WebApp объект:', this.tg);
                    console.log('initDataUnsafe:', this.tg.initDataUnsafe);
                    console.log('initData (raw):', this.tg.initData);
                    console.log('isExpanded:', this.tg.isExpanded);
                    console.log('colorScheme:', this.tg.colorScheme);
                    console.log('platform:', this.tg.platform);
                    console.log('version:', this.tg.version);

                    const initData = this.tg.initDataUnsafe;

                    // Проверяем наличие данных пользователя
                    if (initData && Object.keys(initData).length > 0) {
                        console.log('initDataUnsafe содержит данные:', Object.keys(initData));

                        if (initData.user) {
                            console.log('✅ Данные пользователя из Telegram найдены:', initData.user);

                            this.user = {
                                id: initData.user.id || '',
                                first_name: initData.user.first_name || '',
                                last_name: initData.user.last_name || '',
                                username: initData.user.username || '',
                                language_code: initData.user.language_code || '',
                                is_premium: initData.user.is_premium || false
                            };

                            // Попытка получить фото профиля
                            if (initData.user.photo_url) {
                                this.userPhoto = initData.user.photo_url;
                                console.log('✅ Фото профиля найдено:', this.userPhoto);
                            } else {
                                console.log('⚠️ Фото профиля не найдено, будут использованы инициалы');
                            }

                            console.log('✅ Данные успешно загружены:', this.user);

                            // Показываем приветствие только если это НЕ демо-пользователь
                            if (this.tg.showAlert && this.user.first_name && this.user.first_name !== 'Демо') {
                                const userName = this.user.first_name + (this.user.last_name ? ' ' + this.user.last_name : '');
                                this.tg.showAlert('Добро пожаловать, ' + userName + '!');
                            }
                        } else {
                            console.warn('⚠️ initData есть, но user отсутствует');
                            console.log('Содержимое initData:', JSON.stringify(initData));
                            this.setDemoUser();
                        }
                    } else {
                        console.warn('❌ initDataUnsafe пустой или undefined');
                        console.log('Попытка парсинга initData напрямую...');

                        // Попытка распарсить raw initData
                        if (this.tg.initData) {
                            try {
                                const params = new URLSearchParams(this.tg.initData);
                                const userParam = params.get('user');
                                if (userParam) {
                                    const userData = JSON.parse(decodeURIComponent(userParam));
                                    console.log('✅ Данные пользователя получены через парсинг initData:', userData);

                                    this.user = {
                                        id: userData.id || '',
                                        first_name: userData.first_name || '',
                                        last_name: userData.last_name || '',
                                        username: userData.username || '',
                                        language_code: userData.language_code || '',
                                        is_premium: userData.is_premium || false
                                    };

                                    if (userData.photo_url) {
                                        this.userPhoto = userData.photo_url;
                                    }

                                    console.log('✅ Данные загружены через альтернативный метод:', this.user);
                                    return;
                                }
                            } catch (e) {
                                console.error('Ошибка парсинга initData:', e);
                            }
                        }

                        console.warn('Используем демо-данные');
                        this.setDemoUser();
                    }

                    console.log('=== Загрузка данных завершена ===');
                },
                setDemoUser() {
                    console.log('Установка демо-пользователя');
                    this.user = {
                        id: 'demo123',
                        first_name: 'Демо',
                        last_name: 'Пользователь',
                        username: 'demo_user',
                        language_code: 'ru',
                        is_premium: false
                    };
                },
                goToChannels() {
                    console.log('Переход к каналам');
                    this.showProfileBlock = false;
                    this.showChannelsBlock = true;
                },
                backToProfile() {
                    console.log('Возврат к профилю');
                    this.showChannelsBlock = false;
                    this.showPlayerBlock = false;
                    this.showProfileBlock = true;
                },
                async fetchChannels() {
                    try {
                        const response = await fetch('http://64.227.72.36:8083/api/v1/playlist/page?page=1&perpage=10');
                        const data = await response.json();
                        this.channels = data.data.filter(channel => channel.isVisible);
                    } catch (error) {
                        console.error('Error fetching channels:', error);
                    }
                },
                onImageClick(channel) {
                    this.channel = channel;
                    this.showChannelsBlock = false;
                    this.showPlayerBlock = true;
                    
                    this.$nextTick(() => {
                        this.autoplay(channel);
                    });
                },
                onLockedImageClick(channel) {
                    this.tg.showAlert("Чтобы смотреть этот канал, вы должны иметь подписку");
                },
                autoplay(channel) {
                    const streamUrl = channel.channelLink;

                    if (streamUrl) {
                        if (Hls.isSupported()) {
                            if (this.hls) {
                                this.hls.destroy();
                            }
                            this.hls = new Hls();
                            this.hls.loadSource(streamUrl);
                            this.hls.attachMedia(this.$refs.video);
                            this.$refs.video.play();
                        } else if (this.$refs.video.canPlayType('application/vnd.apple.mpegurl')) {
                            this.$refs.video.src = streamUrl;
                            this.$refs.video.addEventListener('loadedmetadata', () => {
                                this.$refs.video.play();
                            });
                        }
                    }
                },
                close_webapp() {
                    this.tg.close();
                },
                back() {
                    if (this.hls) {
                        this.hls.destroy();
                        this.hls = null;
                    }
                    this.showPlayerBlock = false;
                    this.showChannelsBlock = true;
                    this.channel = null;
                }
            }
        });
    </script>
</body>
</html>

